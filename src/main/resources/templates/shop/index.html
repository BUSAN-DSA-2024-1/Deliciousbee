<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliciousBee - 맛집 찾기</title>
    <link rel="stylesheet" href="/css/index.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="nav-container">
        <div class="navbar-brand-group">
            <a class="navbar-brand" href="/">Delicious Bee</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <!-- 로그인 상태에 따라 보여줄 항목을 JavaScript로 제어 -->
                <li class="nav-item admin-page" style="display: none;">
                    <a href="#" onclick="location.href='/admin'" >관리자 페이지</a>
                </li>
                <li class="nav-item restaurant-write" style="display: none;">
                    <a href="#" class="nav-link" onclick="location.href='/restaurant/rtwrite'">맛집등록</a>
                </li>
                <li class="nav-item"><a class="nav-link" href="#!">커뮤니티</a></li>

                <!-- 로그인 상태에 따른 정보 표시 -->
                <div class="tooltip-container logged-in-menu" style="display: none;">
                    <div class="button-content">
                        <span class="text">내 정보</span>
                    </div>
                    <div class="tooltip-content">
                        <div class="infos">
                            <a href="#" id="myPageLink" class="info">
                                <p>마이페이지</p>
                            </a>
                            <a href="#" class="info" id="logoutButton">
                                <p>로그아웃</p>
                            </a>
                        </div>
                    </div>
                </div>
                <li class="nav-item logged-out-menu" style="display: block;">
                    <a class="nav-link" id="loginButton" href="#">로그인</a>
                </li>
            </ul>
        </div>
    </div>
</nav>



<main>
    <div class="content">
        <div class="search-section">
            <p class="main-title">DeliciousBee</p>
            <form action="restaurant/search" method="get" class="search-container">
                <svg class="search-icon" aria-hidden="true" viewBox="0 0 24 24">
                    <g>
                        <path
                                d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path>
                    </g>
                </svg>
                <input type="text" name="keyword" placeholder="Search" class="search-input">
                <button type="submit" style="display: none;">검색</button> </form>
            <p class="search-intro">당신이 찾는 모든 맛</p>
        </div>
        <section class="restaurant-card">
            <div class="rest-title">
                <h3 class="rest-title-1">
                    #오늘의 추천 맛집
                </h3>
                <div class="slider-buttons">
                    <button class="slide-left">&lt;</button>
                    <button class="slide-right">&gt;</button>
                </div>
            </div>
            <ul class="card">
                <li class="img-content" th:each="restaurant : ${restaurantlist}"
                    th:onclick="|window.location.href='@{/restaurant/rtread/{restaurantId}(restaurantId=${restaurant.id})}'|">
                    <div class="content-wrapper">
                        <div class="image-wrapper" th:each="file : ${restaurant.attachedFile}">
                            <img th:if="${#lists.size(restaurant.attachedFile) > 0}" th:src="@{'/restaurant/display?filename='+${file.saved_filename}}" alt="레스토랑 이미지"/>
                            <p th:if="${#lists.size(restaurant.attachedFile) == 0}">이미지가 없습니다</p>
                        </div>
                        <div class="intro-content">
                            <p class="heading" th:text="${restaurant.name}"></p>
                            <p th:text="${restaurant.description}"></p>
                            <p th:text="|별점: ${restaurant.average_rating}|"></p>
                        </div>
                    </div>
                    <h2 class="star-rating" th:text="${restaurant.name}"></h2>
                </li>
            </ul>
        </section>
    </div>

    <!-- 로그인 모달 -->
    <div id="loginModal" class="modal">
        <div class="form-container">
            <span class="close" onclick="closeModal()">×</span>
            <p class="title">DeliciousBee</p>
            <form action="/member/login" method="post" class="form">
                <input type="text" name="member_id" class="input" placeholder="아이디">
                <input type="password" name="password" class="input" placeholder="비밀번호">
                <p class="page-link">
                    <span class="page-link-label">Forgot Password?</span>
                </p>
                <button class="form-btn" type="submit">Log in</button>
            </form>
            <div class="buttons-container">
                <div class="google-login-button">
                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" version="1.1" x="0px" y="0px"
                         class="google-icon" viewBox="0 0 48 48" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                        <path fill="#FFC107"
                              d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24 c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                        <path fill="#FF3D00"
                              d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657 C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                        <path fill="#4CAF50"
                              d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36 c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                        <path fill="#1976D2"
                              d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    </svg>
                    <a href="/oauth2/authorization/google" class="google-text">Login with google</a>
                    <a href="/oauth2/authorization/line">Line으로 로그인</a>
                </div>
            </div>
            <p class="sign-up-label">
                Don't have an account?<a href="member/join" class="sign-up-link" >회원가입</a>
            </p>
        </div>
    </div>
</main>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("페이지 로드 완료");

        // 페이지 로드 시 인증 상태 확인
        checkAuth();

        // OAuth2 콜백 URL 처리
        if (window.location.pathname.includes('/login/oauth2/code/google')) {
            console.log("OAuth2 콜백 URL 확인");
            // OAuth2 인증 후 서버가 쿠키를 설정하고 리디렉트하므로 추가 처리는 필요 없음
        }

        // 로그인 모달 제어
        var loginButton = document.getElementById('loginButton');
        if (loginButton) {
            loginButton.addEventListener('click', function (event) {
                event.preventDefault();
                var loginModal = document.getElementById('loginModal');
                if (loginModal) loginModal.style.display = 'block';
            });
        }

        // 로그아웃 버튼에 이벤트 리스너 추가
        var logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', function(event) {
                event.preventDefault();
                logout();
            });
        }

        // 로그아웃 함수
        function logout() {
            fetch('member/logout', {
                method: 'POST',
                credentials: 'include'  // 쿠키 포함
            })
                .then(response => {
                    if (response.ok) {
                        alert('로그아웃되었습니다.');
                        location.reload();  // 로그아웃 후 페이지 새로고침
                    } else {
                        alert('로그아웃에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('로그아웃 오류:', error);
                    alert('로그아웃 중 오류가 발생했습니다.');
                });
        }

        // 마이페이지 이동
        var myPageLink = document.getElementById('myPageLink');
        if (myPageLink) {
            myPageLink.addEventListener('click', function (event) {
                event.preventDefault();
                fetch('member/api/check-auth', {
                    method: 'GET',
                    credentials: 'include'  // 쿠키 포함
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.isAuthenticated) {
                            window.location.href = '/member/myPage';
                        } else {
                            alert('인증 실패: 다시 로그인해 주세요.');
                            window.location.href = '/member/login';
                        }
                    })
                    .catch(error => {
                        console.error('오류 발생:', error);
                        alert('오류 발생');
                    });
            });
        }

        // 일반 로그인 처리
        var loginForm = document.querySelector('#loginModal form');
        if (loginForm) {
            loginForm.addEventListener('submit', function (event) {
                event.preventDefault();
                var formData = new FormData(loginForm);
                var loginData = {
                    member_id: formData.get('member_id'),
                    password: formData.get('password')
                };
                fetch('member/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData),
                    credentials: 'include'  // 쿠키 포함
                })
                    .then(response => {
                        if (response.ok) return response.text();
                        throw new Error('로그인 실패');
                    })
                    .then(message => {
                        alert(message);
                        closeModal();
                        // 로그인 성공 시 인증 상태 확인
                        checkAuth();
                    })
                    .catch(error => {
                        console.error('로그인 오류 발생:', error);
                        alert('로그인에 실패했습니다.');
                    });
            });
        }

        function closeModal() {
            var loginModal = document.getElementById('loginModal');
            if (loginModal) loginModal.style.display = 'none';
        }

        // 인증 상태 확인 함수
        function checkAuth() {
            fetch('member/api/check-auth', {
                method: 'GET',
                credentials: 'include'  // 쿠키 포함
            })
                .then(response => response.json())
                .then(data => {
                    if (data.isAuthenticated) {
                        document.querySelector('.logged-in-menu').style.display = 'block';
                        document.querySelector('.logged-out-menu').style.display = 'none';
                        document.querySelector('.restaurant-write').style.display = 'block';
                        // 관리자 권한 확인
                        if (data.isAdmin) {
                            document.querySelector('.admin-page').style.display = 'block';
                        }
                    } else {
                        document.querySelector('.logged-in-menu').style.display = 'none';
                        document.querySelector('.logged-out-menu').style.display = 'block';
                        document.querySelector('.restaurant-write').style.display = 'none';
                        document.querySelector('.admin-page').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('인증 상태 확인 오류:', error);
                    // 인증 상태를 알 수 없으므로 기본적으로 로그아웃 상태로 설정
                    document.querySelector('.logged-in-menu').style.display = 'none';
                    document.querySelector('.logged-out-menu').style.display = 'block';
                    document.querySelector('.restaurant-write').style.display = 'none';
                    document.querySelector('.admin-page').style.display = 'none';
                });
        }
    });
</script>


</body>
</html>
