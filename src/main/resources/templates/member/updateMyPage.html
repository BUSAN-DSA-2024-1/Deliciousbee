<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/css/updateMyPage.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<title>ë§ˆì´í˜ì´ì§€ ìˆ˜ì •í•˜ê¸°</title>
</head>
<body>
	<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” ì‚½ì… -->
	<th:block th:replace="~{fragments/navbar-login :: navbar}"></th:block>
	<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ ì‚½ì… -->
	<th:block th:replace="~{fragments/navbar-login :: loginModal}"></th:block>



	<form action="/myPage/updateMyPage" onsubmit="return formCheck()" method="POST" enctype="multipart/form-data">
		<div class="main-image">
			<!-- ë©”ì¸ ì´ë¯¸ì§€ -->
			  <img th:if="${myPage.mainImage == null}" src="/myPageImage/no-main-image.png" alt="ê¸°ë³¸ ì´ë¯¸ì§€"
                class="default-main-image" id="mainImagePreview">
            <img th:unless="${myPage.mainImage == null}"
                th:src="@{'/loginMember/display?filename=' + ${loginMember.profileImage.saved_filename}}"
                alt="ë©”ì¸ ì´ë¯¸ì§€" id="mainImagePreview">

			<div class="image-upload-container">
				<label for="mainImageInput" class="image-upload-button"> <img
					src="/myPageImage/image-upload-icon.png" alt="ì—…ë¡œë“œ ì•„ì´ì½˜">
				</label> <input type="file" id="mainImageInput" accept="image/*"
					style="display: none;">
			</div>

			<!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
			<a th:href="@{/member/myInfo}" class="profile-image"
				title="í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½"> <img
				th:if="${myPage.beeMember.profileImage == null}"
				src="/myPageImage/no-profil.png" alt="ê¸°ë³¸ ì´ë¯¸ì§€"
				class="my-profile-image"> <img
				th:unless="${myPage.beeMember.profileImage == null}"
				th:src="@{'/member/display?filename=' + ${loginMember.profileImage.saved_filename}}"
				alt="ë©”ì¸ ì´ë¯¸ì§€" class="my-profile-image"> <span
				class="tooltip-text">í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½</span> <!-- ì»¤ìŠ¤í…€ íˆ´íŒ -->
			</a>
		</div>


		<div class="myPageOwner">
			<div class="owner-profile">
				<div class="nickname-header">
					<h4 class="nickname"
						th:text="${myPage.beeMember.nickname} + ' ë‹˜ì˜ ë§ˆì´í˜ì´ì§€(ìˆ˜ì • í˜ì´ì§€)' "></h4>
					<div class="save-button">
						<button type="submit" class="save-btn">
							<img src="/myPageImage/save-icon.png" alt="ì €ì¥í•˜ê¸° ì•„ì´ì½˜">
						</button>
					</div>
					<div class="goMyInfo-button">
						<a class="update-btn" onclick="location.href='/member/myInfo'">
							<img src="/myPageImage/update-icon.png" alt="ìˆ˜ì •í•˜ê¸° ì•„ì´ì½˜">
						</a>
					</div>
				</div>
				<h4 class="intro-title">ì†Œê°œê¸€</h4>
				<input type="text" name="introduce" id="introduceInput"
					th:value="${myPage.introduce}"
					th:placeholder="${myPage.introduce == null || myPage.introduce.isEmpty()} ? 'ì†Œê°œê¸€ì„ ì…ë ¥í•˜ì„¸ìš”' : ''"
					maxlength="100" oninput="updateCharacterCount()">
				<p id="charCount">0/100 ì</p>
			</div>


			<div class="owner-stats">
				<span th:text="'ë¦¬ë·°í•œìˆ˜ : ' + ${myPage.beeMember.review.size()}"></span>
				<span
					th:text="'í‰ê·  ë³„ì  : (' + ${#numbers.formatDecimal(averageRating, 1, 1)} + '/5.0)'"></span>
				<span th:text="'ì¡°íšŒìˆ˜: ' + ${myPage.hit}"></span> <span
					th:text="'ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜: ' + ${todayVisitCount}"></span> <a
					class="today_visitor" onclick="showVisitorsModal()">ì˜¤ëŠ˜ì˜ ë°©ë¬¸ìë³´ê¸°</a>
			</div>
		</div>

		<!-- ì˜¤ëŠ˜ì˜ ë°©ë¬¸ì ëª©ë¡ ëª¨ë‹¬ -->
		<div id="visitorsModal" class="list-modal">
			<div class="visit-modal-content">
				<span class="close" onclick="closeVisitorsModal()">Ã—</span>
				<h3>ì˜¤ëŠ˜ì˜ ë°©ë¬¸ì</h3>
				<ul>
					<li th:each="visit : ${visitors}"><a
						th:href="@{/member/myPage(id=${visit.visitor.myPage.id})}"
						th:text="${visit.visitor.nickname}"></a></li>
				</ul>
			</div>
		</div>

		<div class="myPageMain">
			<div id="reviewListContainer" th:if="${!reviews.isEmpty()}"
			class="myPageReview">
			<div th:each="review, status : ${reviews}" class="review-box"
				th:id="'reviewBox' + ${status.index}">
				<div class="restaurant_name_head">
					<span><img src="/image/bee.jpg" alt="ë²Œ ì´ë¯¸ì§€"
						style="width: 35px; height: 35px; object-fit: cover;"></span> <a
						th:href="@{/restaurant/rtread(id=${review.restaurant.id})}"
						title="ì‹ë‹¹ ì •ë³´ë¡œ ì´ë™"> <span th:text="${review.restaurant.name}"
						class="restaurant_name" style="text-decoration: none;"></span>
					</a>
					<div class="rating-stars">
						<span th:each="i : ${#numbers.sequence(1, 5)}"> <img
							th:if="${review.rating >= i}" src="/myPageImage/full_star.png"
							alt="ê½‰ ì°¬ ë³„"> <img th:unless="${review.rating >= i}"
							src="/myPageImage/empty_star.png" alt="ë¹ˆ ë³„">
						</span>
					</div>
					<span class="review-date"
						th:text="'ë°©ë¬¸ ë‚ ì§œ :   ' + ${review.visitDate}"></span> <span
						class="go-review"> <a
						th:href="@{/restaurant/rtread/{restaurantId}(restaurantId=${review.restaurant.id}, reviewId=${review.id})}">ë¦¬ë·°ë³´ëŸ¬
							ê°€ê¸°</a>
					</span>
				</div>
				<div class="img-and-review">
					<div class="image-box"
						th:if="${review.attachedFile != null and !review.attachedFile.isEmpty()}">
						<div th:if="${review.attachedFile.size() > 1}">
							<img
								th:src="@{'/review/display?filename='+${review.attachedFile[0].saved_filename}}"
								alt="Review Image"
								style="width: 160px; height: 160px; object-fit: cover;">
							<div class="image-more-button"
								th:onclick="|showImageModal(${review.id})|">
								ì‚¬ì§„ ë”ë³´ê¸° <span th:text="|+${review.attachedFile.size() - 1}|"></span>
							</div>
							<div class="image-modal" th:id="'imageModal' + ${review.id}">
								<div class="image-modal-content">
									<span class="close-modal"
										th:onclick="|closeImageModal(${review.id})|">Ã—</span>
									<div th:each="file : ${review.attachedFile}">
										<img
											th:src="@{'/review/display?filename='+${file.saved_filename}}"
											alt="Review Image"
											th:onclick="|showLargeImageModal('@{'/review/display?filename='+${file.saved_filename}}', ${review.id})|">
									</div>
								</div>
							</div>

							<!-- largeImageModalì„ imageModalê³¼ ê°™ì€ ë ˆë²¨ë¡œ ì´ë™ -->
							<div id="largeImageModal" class="modal">
								<div class="large-image-modal-content">
									<span class="close-modal" onclick="closeLargeImageModal()">Ã—</span>
									<img id="largeImage" src="" alt="Large Image">
								</div>
							</div>
						</div>
						<div th:unless="${review.attachedFile.size() > 1}">
							<img
								th:src="@{'/review/display?filename='+${review.attachedFile[0].saved_filename}}"
								alt="Review Image"
								style="width: 160px; height: 160px; object-fit: cover;"
								th:onclick="|showLargeImageModal('@{'/review/display?filename='+${review.attachedFile[0].saved_filename}}')|">
						</div>
					</div>
					<div class="image-box"
						th:unless="${review.attachedFile != null and !review.attachedFile.isEmpty()}">
						<img src="/myPageImage/no-review-img.jpg" alt="No Review Image"
							style="width: 160px; height: 160px; object-fit: cover;">
					</div>
					<div class="review-main">
						<div class="review-rating">
							<p>
								ì¹œì ˆ í¬ì¸íŠ¸: <span class="gauge-container"> <span
									class="gauge"
									th:style="'width:' + ${review.kindRating * 33.33} + '%; background-color:' + (${review.kindRating == 1 ? '#ff4c4c' : (review.kindRating == 2 ? '#ffc107' : '#4caf50')})"></span>
								</span> ë§› í¬ì¸íŠ¸: <span class="gauge-container"> <span
									class="gauge"
									th:style="'width:' + ${review.tasteRating * 33.33} + '%; background-color:' + (${review.tasteRating == 1 ? '#ff4c4c' : (review.tasteRating == 2 ? '#ffc107' : '#4caf50')})"></span>
								</span> ê°€ê²© í¬ì¸íŠ¸: <span class="gauge-container"> <span
									class="gauge"
									th:style="'width:' + ${review.priceRating * 33.33} + '%; background-color:' + (${review.priceRating == 1 ? '#ff4c4c' : (review.priceRating == 2 ? '#ffc107' : '#4caf50')})"></span>
								</span>
							</p>
						</div>
						<div class="review-comment">
							<div class="recommendItems">
								<span>ì¶”ì²œ ë©”ë‰´: </span> <span
									th:each="reviewMenu, iterStat : ${review.reviewMenuList}"
									th:text="${reviewMenu?.menu?.name 
                ?: reviewMenu?.customMenuName 
                ?: ''} + ${!iterStat.last ? ', ' : ''}"></span>
							</div>
							<div class="review_content"
								th:id="'reviewContent' + ${review.id}"
								th:data-short-content="${review.reviewContents.length() > 100 ? review.reviewContents.substring(0, 100) : review.reviewContents}"
								th:data-full-content="${review.reviewContents}">

								<span th:id="'shortContent' + ${review.id}"
									th:text="${review.reviewContents.length() > 100 ? review.reviewContents.substring(0, 100) + '...' : review.reviewContents}">
								</span> <span th:id="'fullContent' + ${review.id}"
									th:text="${review.reviewContents}" style="display: none;"></span>

								<a th:if="${review.reviewContents.length() > 100}"
									th:id="'moreButton' + ${review.id}" class="more-button"
									th:attr="onclick=|toggleReview(this, '${review.id}')|">ë”ë³´ê¸°</a>
							</div>
						</div>
						<div class="review-create-date"
								th:text="'ë¦¬ë·° ì‘ì„± ë‚ ì§œ : '+ ${review.createDate}">
						</div>
					</div>
				</div>
			</div>
		</div>
			<div class="no-review"
				th:unless="${!myPage.beeMember.review.isEmpty()}">
				<div class="no-review-info">
					ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤ã… 
					<p th:if="${#authentication.isAuthenticated() and isOwner}">
						<a href="rtlist.html">ë¦¬ë·° ì‘ì„±í•˜ëŸ¬ ê°€ê¸°</a> ğŸ‘‰
					</p>
				</div>
			</div>
			<div class="ranking">
				<h2>ë¦¬ë·°ì™•ğŸ‘‘</h2>
				<table class="table table-striped">
					<thead>
						<tr>
							<th>#</th>
							<th style="text-align: left;">ë‹‰ë„¤ì„</th>
							<th style="text-align: light; white-space: nowrap;">ë¦¬ë·° ìˆ˜</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="myPage, status : ${reviewCount}"
							th:if="${status.index} < 4">
							<td class="center" th:if="${status.index} == 0">ğŸ¥‡</td>
							<td class="center" th:if="${status.index} == 1">ğŸ¥ˆ</td>
							<td class="center" th:if="${status.index} == 2">ğŸ¥‰</td>
							<td class="center" th:unless="${status.index} < 3"
								th:text="${status.index + 1} + ." style="padding-left: 8px;"></td>
							<td class="center"><a
								th:href="@{/member/myPage(id=${myPage.id})}"
								class="nickname-link"> <span
									th:text="${myPage.beeMember.nickname}"></span>
							</a> ë‹˜</td>
							<td class="center" style="text-align: center;"
								th:text="${myPage.beeMember.review.size()}"></td>
						</tr>
					</tbody>
				</table>
				
			</div>
		</div>
		
		
	</form>
	<!-- ìœ„ë¡œê°€ëŠ” í™”ì‚´í‘œ ë²„íŠ¼ -->
	<a onclick="scrollToTop()" id="scrollToTopButton"> <svg
			xmlns="http://www.w3.org/2000/svg" width="24" height="24"
			viewBox="0 0 24 24" fill="none" stroke="currentColor"
			stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
			class="feather-arrow-up">
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="7 10 12 5 17 10"></polyline>
    </svg>
	</a>

	<div class="under-bar">
		<img src="/image/bee.jpg" class="under-image"> <span
			class="under-comment">DeliciousBee</span>
	</div>


	 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
		//íŒ”ë¡œì›Œ**************
		async function toggleFollow(button) {
    const followingId = button.dataset.followingId;
    const isFollowing = button.textContent === 'ì–¸íŒ”ë¡œìš°';
    const url = isFollowing ? `/unfollow/${followingId}` : `/follow/${followingId}`;

    try {
        const response = await fetch(url, { method: 'POST' });
        const success = await response.json(); 

        if (success) {
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° í´ë˜ìŠ¤ ë³€ê²½
            button.textContent = isFollowing ? 'íŒ”ë¡œìš°' : 'ì–¸íŒ”ë¡œìš°';
            button.classList.toggle('follow-button', !isFollowing); // ì–¸íŒ”ë¡œìš° ì‹œ btn-secondary ì¶”ê°€
            button.classList.toggle('nofollow', isFollowing); // íŒ”ë¡œìš° ì‹œ btn-primary ì¶”ê°€
        } else {
            alert('íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš° ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
   			 } catch (error) {
        	console.error('íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        	alert('íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
   		  }
		}		
		//ë¡œê·¸ì¸ì•ˆí•œì‚¬ëŒ íŒ”ë¡œì›Œí•˜ë ¤í• ë•Œ**************
		function showLoginAlert() {
	        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
	        return true; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
	    }
		


		// ì˜¤ëŠ˜ì˜ ë°©ë¬¸ì ëª©ë¡ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
		function showVisitorsModal() {
		    document.getElementById('visitorsModal').style.display = 'block';

		    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
		    window.onclick = function (event) {
		        if (event.target == document.getElementById('visitorsModal')) {
		            closeVisitorsModal();
		        }
		    };
		}

		// ì˜¤ëŠ˜ì˜ ë°©ë¬¸ì ëª©ë¡ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
		function closeVisitorsModal() {
		    document.getElementById('visitorsModal').style.display = 'none';
		    window.onclick = null; // ë‹«í ë•Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
		}



		//ë”ë³´ê¸° ë²„íŠ¼
		function toggleReview(button, reviewId) {
		  var shortContent = document.getElementById('shortContent' + reviewId);
		  var fullContent = document.getElementById('fullContent' + reviewId);

		  if (button.textContent === 'ë”ë³´ê¸°') {
		    shortContent.style.display = 'none'; // ì§§ì€ ë‚´ìš© ìˆ¨ê¹€
		    fullContent.style.display = 'inline'; // ì „ì²´ ë‚´ìš© í‘œì‹œ
		    button.textContent = 'ì ‘ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
		  } else {
		    shortContent.style.display = 'inline'; // ì§§ì€ ë‚´ìš© í‘œì‹œ
		    fullContent.style.display = 'none'; // ì „ì²´ ë‚´ìš© ìˆ¨ê¹€
		    button.textContent = 'ë”ë³´ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
		  }
		}

// ìœ„ë¡œê°€ëŠ” í™”ì‚´í‘œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth' // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ íš¨ê³¼
    });
}

//ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ (showImageModal ì™¸ë¶€ë¡œ ì´ë™)
function closeImageModal(reviewId) {
  document.getElementById('imageModal' + reviewId).style.display = 'none';
  window.removeEventListener('click', handleImageModalOutsideClick);  // ë¦¬ìŠ¤ë„ˆ ì œê±°
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
function showImageModal(reviewId) {
  const modal = document.getElementById('imageModal' + reviewId);
  modal.style.display = 'block';

  // ì´ë¯¸ì§€ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (í´ë¡œì € í•¨ìˆ˜ ì‚¬ìš©)
  function handleImageModalOutsideClick(event) {
    if (event.target == modal) {
      closeImageModal(reviewId); // ì´ì œ ì™¸ë¶€ì—ì„œ ì •ì˜ëœ closeImageModal í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
    }
  }
  window.addEventListener('click', handleImageModalOutsideClick);
}

//í° ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ (showLargeImageModal ì™¸ë¶€ë¡œ ì´ë™)
function closeLargeImageModal() {
  document.getElementById('largeImageModal').style.display = 'none';
  window.removeEventListener('click', handleLargeImageModalOutsideClick); // ë¦¬ìŠ¤ë„ˆ ì œê±°
}

// í° ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
function showLargeImageModal(imageUrl) {
  const modal = document.getElementById('largeImageModal');
  document.getElementById('largeImage').src = imageUrl;
  modal.style.display = 'block';

  // í° ì´ë¯¸ì§€ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (í´ë¡œì € í•¨ìˆ˜ ì‚¬ìš©)
  function handleLargeImageModalOutsideClick(event) {
    if (event.target == modal) {
      closeLargeImageModal(); // ì´ì œ ì™¸ë¶€ì—ì„œ ì •ì˜ëœ closeLargeImageModal í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
    }
  }
  window.addEventListener('click', handleLargeImageModalOutsideClick);
}
 
//ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
 const mainImageInput = document.getElementById('mainImageInput');
           const mainImagePreview = document.getElementById('mainImagePreview');

           mainImageInput.addEventListener('change', function(e) {
               if (e.target.files && e.target.files[0]) {
                   const reader = new FileReader();
                   reader.onload = function(e) {
                       mainImagePreview.src = e.target.result;
                   }
                   reader.readAsDataURL(e.target.files[0]);
               }
           });
</script>
<script th:src="@{/js/layout.js}"></script> 

</body>

</html>